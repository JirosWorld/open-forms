# Generated by Django 4.2.16 on 2024-11-29 18:33

import re

from django.db import migrations
from django.db.migrations.state import StateApps
from django.db.models import Q

SUMMARY_REGEX = r"{%\s*summary\s*%}"


def replace_tag(tpl: str | None) -> str | None:
    if tpl is None:
        return None
    return re.sub(
        SUMMARY_REGEX,
        "{% confirmation_summary %}",
        tpl,
    )


def update_summary_tags(apps: StateApps, _):
    ConfirmationEmailTemplate = apps.get_model("emails", "ConfirmationEmailTemplate")
    # * The field cosign_content is new in 3.0.0 so it's not expected to hold the legacy
    #   tag.
    # * At this point in time, only nl/en are supported.
    q = Q(content_nl__regex=SUMMARY_REGEX) | Q(content_en__regex=SUMMARY_REGEX)
    qs = ConfirmationEmailTemplate.objects.filter(q)
    for obj in qs:
        obj.content_en = replace_tag(obj.content_en)
        obj.content_nl = replace_tag(obj.content_nl)
        obj.save()


class Migration(migrations.Migration):

    dependencies = [
        ("emails", "0002_confirmationemailtemplate_cosign_content_and_more"),
    ]

    operations = [
        # reverse not needed, since the new format worked on old code too
        migrations.RunPython(update_summary_tags, migrations.RunPython.noop),
    ]
